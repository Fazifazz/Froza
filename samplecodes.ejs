<%- include('../layouts/header') %>

<body>

	<div class="colorlib-loader"></div>

	<div id="page">
		<%- include('../layouts/userNav') %>

		<div class="breadcrumbs">
			<div class="container">
				<div class="row">
                    <div class="col">
                        <p class="bread"><span><a href="index.html">Home</a></span> / <span>Shop</span></p>
					</div>

                    <% if (success && success.length > 0) { %>
                        <div class="alert alert-success text-center" id="success-message">
                          <% success.forEach(function(message) { %>
                            <p><%= message %></p>
                          <% }); %>
                        </div>
                        <script>
                            setTimeout(function() {
                              var successMessage = document.getElementById('success-message');
                              if (successMessage) {
                                successMessage.style.display = 'none';
                              }
                            }, 2000); 
                          </script>
                        <% } %>

				</div>
			</div>
		</div>

		<div class="colorlib-product">
			<div class="container">
                <form action="/shop">
                    <button type="submit">Clear All Filters</button>
                </form>

				<div class="row">
					<div class="col-lg-3 col-xl-3">
						<div class="row">
							<div class="col-sm-12">
								<div class="side border mb-1">
									<h3>Brand</h3>
									<!-- Update the links with brand filters -->
<ul>
    <% brands.forEach((brand) => { %>
        <li><a href="/shop?brand=<%= encodeURIComponent(brand) %>"><%= brand.toUpperCase() %></a></li>
    <% }); %>
</ul>

								</div>
							</div>
                            <div class="col-sm-12">
                                <div class="side border mb-1">
                                    <h3>Price Range</h3>
                                    <form action="/shop" method="get">
                                        <label for="minPrice">Min Price:</label>
                                        <input type="text" id="minPrice" name="minPrice">
                                        <label for="maxPrice">Max Price:</label>
                                        <input type="text" id="maxPrice" name="maxPrice">
                                        <center><button type="submit">Apply</button></center>
                                    </form>
                                </div>
                            </div>
<!-- Filter by Category -->
<div class="col-sm-12">
    <div class="side border mb-1">
        <h3>Category</h3>
        <ul>
            <% categories.forEach((category) => { %>
                <li><a href="/shop?category=<%= encodeURIComponent(category) %>"><%= category.toUpperCase() %></a></li>
            <% }); %>
        </ul>
    </div>
</div>



							<div class="col-sm-12">
								<div class="side border mb-1">
									<h3>Colors</h3>
									<ul>
										<li><a href="#">Black</a></li>
										<li><a href="#">White</a></li>
										<li><a href="#">Blue</a></li>
										<li><a href="#">Red</a></li>
										<li><a href="#">Green</a></li>
										<li><a href="#">Grey</a></li>
										<li><a href="#">Orange</a></li>
										<li><a href="#">Cream</a></li>
										<li><a href="#">Brown</a></li>
									</ul>
								</div>
							</div>
						</div>
					</div>

					<div class="col-lg-9 col-xl-9">
                        <!-- Add the conditional code to display the selected brand here -->
                        <% if (selectedBrand) { %>
                            <h2>Products by <%= selectedBrand %></h2>
                        <% } %>

						<% if (selectedCategory) { %>
							<h2>Products in Category: <%= selectedCategory %></h2>
						<% }%>
                            
                        <!-- Your product listing starts here -->
                        <div class="row row-pb-md">
                            <% products.forEach((prdct) => { %>
                                <% if (!prdct.is_deleted) { %>
                                    <div class="col-lg-3 mb-4 text-center">
                                        <div class="product-entry border">
                                            <div class="prod-img">
                                                <a href="/shop/<%= prdct._id %>">
                                                    <img src="<%= prdct.images[0] %>" class="img-fluid" alt="<%= prdct.title.toUpperCase()%>">
                                                </a>
                                            </div>
                                            <div class="desc">
                                                <h2><a href="#"><%= prdct.title.toUpperCase() %></a></h2>
                                                <h5 class="text-secondary"><%= prdct.brand.toUpperCase() %></h5>
                                                <span class="price">&#8377;<%= prdct.regularPrice %></span>
                                            </div>
                                            <% if(prdct.stock===0){ %>
                                                <p class="text-danger">Out of Stock!</p>
                                                <% }else{ %>
                                            <div class="icons">
                                                <form action="/cart/<%= prdct._id %>" method="post">
                                                    <input type="hidden" name="productId" value="<%= prdct._id %>">
                                                    <button class="btn btn-dark" type="submit">
                                                        <i class="fa fa-shopping-cart"></i> Add to Cart
                                                    </button>
                                                </form>
                                                <a class="btn btn-success" href="#">
                                                    <i class="fa fa-shopping-bag"></i> Shop Now
                                                </a>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>
                            <% }) %>
                        </div>
						<!-- Pagination -->
						<div class="row">
							<div class="col-md-12 text-center">
								<div class="block-27">
									<ul>
										<% if (currentPage > 1) { %>
											<li><a href="?page=<%= currentPage - 1 %>"><i class="ion-ios-arrow-back"></i></a></li>
										<% } %>
										
										<% for (let i = 1; i <= totalPages; i++) { %>
											<li <% if (i === currentPage) { %>class="active"<% } %>><a href="?page=<%= i %>"><span><%= i %></span></a></li>
										<% } %>

										<% if (currentPage < totalPages) { %>
											<li><a href="?page=<%= currentPage + 1 %>"><i class="ion-ios-arrow-forward"></i></a></li>
										<% } %>
									</ul>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<%- include('../layouts/footer') %>





        const ITEMS_PER_PAGE = 8;  // Adjust the number of items per page as needed

exports.showshopIndex = async (req, res) => {
  const page = parseInt(req.query.page) || 1; // Get the requested page number, default to 1
  const skip = (page - 1) * ITEMS_PER_PAGE;

  

  try {
    const totalProducts = await Product.countDocuments(); // Get the total number of products
    const products = await Product.find().skip(skip).limit(ITEMS_PER_PAGE); // Get products for the current page
    const totalPages = Math.ceil(totalProducts / ITEMS_PER_PAGE); // Calculate total pages

    res.render('users/shop', { products, success: req.flash('success'), currentPage: page, totalPages });
  } catch (error) {
    console.error('Error fetching products:', error);
    res.status(500).send('Internal Server Error');
  }
};